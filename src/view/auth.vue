<template lang="pug">
#auth-container
  h1 账户管理

  .mbox.info(v-if='$route.query.tips', style='margin-bottom: 1rem')
    .title Tips
    p 请先登录

  section(v-if='user.profile')
    .card
      h2 Hello, {{ user.profile.name }}
      .align-center
        button(@click.prevent='handleSignOut') 退出登录

  section(v-else)
    form.form.card.align-center(:class='{ "loading-cover": onAuthenticating }')
      h2(style='left: 0; transform: none') 登录
      label
        strong 用户名
        input(v-model='email')
      label
        strong 密码
        input(v-model='password', type='password')
      div
        button(@click.prevent='handleLogin') 登录
      //- Error
      .mbox.error(v-if='errorMsg')
        .title {{ errorTitle }}
        p {{ errorMsg }}
</template>

<script setup lang="ts">
import { onMounted, ref } from 'vue'
import { setTitle } from '../utils/setTitle'
import { getErrMsg } from '../utils/getErrMsg'
import { useRoute, useRouter } from 'vue-router'
import { useUserStore } from '@/stores/user'

const route = useRoute()
const router = useRouter()
const user = useUserStore()

const onAuthenticating = ref(false)
const email = ref('')
const password = ref('')
const errorTitle = ref('')
const errorMsg = ref('')

function handleLogin() {
  if (!email.value || !password.value) return

  onAuthenticating.value = true
  errorTitle.value = ''
  errorMsg.value = ''

  user
    .login(email.value, password.value)
    .then(
      (data) => {
        console.log('auth ok', data)
        return user.fetchProfile()
      },
      (err) => {
        console.warn('auth faild', err)
        errorTitle.value = 'Auth failed'
        errorMsg.value = getErrMsg(err)
      }
    )
    .then(
      (profile) => {
        console.log('profile ok', profile)
        if (route.query.from) {
          router.push(route.query.from as string)
        }
      },
      (err) => {
        console.warn('profile faild')
        errorTitle.value = 'Faild to get profile'
        errorMsg.value = getErrMsg(err)
      }
    )
    .finally(() => {
      onAuthenticating.value = false
    })
}

function handleSignOut() {
  user.logout()
}

onMounted(() => {
  setTitle('Authorization')
})
</script>

<style scoped lang="sass">
.form
  width: 60%
  margin: 0 auto
  padding: 2rem

  label
    display: flex
    margin: 1rem auto
    align-items: center

    strong
      margin-right: 1rem

    input
      flex: 1
      width: 100%
      padding: 4px 0.75rem
      font-size: 1rem
      line-height: 1.6
      border: none
      border-radius: 1em
      background-color: rgba(0, 0, 0, 0.05)
      outline: none
      &:hover
        box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.25)
      &:focus
        box-shadow: 0 0 0 2px var(--theme-accent-color)

  .mbox
    text-align: left
    margin-top: 1rem

@media (max-width: 600px)
  .form
    width: 90%
    label
      flex-direction: column
</style>
